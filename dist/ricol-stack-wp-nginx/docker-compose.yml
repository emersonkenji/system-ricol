version: '3.8'
services:
  wordpress:
    image: wordpress:6.4-fpm-alpine
    # deploy:
    #   mode: replicated
    #   replicas: 1
    #   update_config:
    #     parallelism: 1
    #     delay: 5s
    #     order: start-first
    #   restart_policy:
    #     condition: on-failure
    #     delay: 5s
    #     max_attempts: 3
    environment:
      WORDPRESS_DB_HOST: global-mariadb
      WORDPRESS_DB_USER: wordpress
      WORDPRESS_DB_PASSWORD: wordpress
      WORDPRESS_DB_NAME: wordpress
      WORDPRESS_TABLE_PREFIX: wp_
      WORDPRESS_CONFIG_EXTRA: |
        define('WP_CACHE', true);
        define('WP_HOME','https://${SITE_URL}');
        define('WP_SITEURL','https://${SITE_URL}');
    # user: "82:82"
    volumes:
      - ./system:/var/www/html
    networks:
      - reverse-proxy

  nginx:
    image: 'nginx:1.25-alpine'
    expose:
      - '80'
      - '443'
    depends_on:
      - phpfpm
    networks:
      - reverse-proxy
    volumes:
      - './system:/var/www/html:cached'
      - './config/nginx/server.conf:/etc/nginx/conf.d/common/_server.conf:cached'
      - './config/nginx/default.conf:/etc/nginx/conf.d/default.conf:cached'
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=reverse-proxy"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}.rule=Host(`${SITE_URL}`)"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}.tls=true"
      - "traefik.http.services.${COMPOSE_PROJECT_NAME}.loadbalancer.server.port=80"  
    
  phpfpm:
    image: <PHP_IMAGE>-<USER_NAME>
    networks:
      - reverse-proxy
    volumes:
      - './system:/var/www/html:cached'
      # - './config/php-fpm/docker-php-ext-xdebug.ini:/etc/php/8.2/fpm/conf.d/docker-php-ext-xdebug.ini:cached'
      - 'wplocaldockerCache:/var/www/.wp-cli/cache:cached'
      - '~/.ssh:/home/<USER_NAME>/.ssh:cached'
      # - '/home/kenji/.wpsnapshots:/home/kenji/.wpsnapshots:cached'
      - '~/.aws:/home/<USER_NAME>/.aws:cached,ro'
      - './config/php-fpm/wp-cli.local.yml:/var/www/.wp-cli/config.yml:cached'
    # cap_add:
    #   - SYS_PTRACE
    environment:
      - PHP_OPCACHE_VALIDATE_TIMESTAMPS=1 
      # ENABLE_XDEBUG: 'true'
      # PHP_IDE_CONFIG: serverName=negocios-test
    build:
      dockerfile: php-fpm
      context: .containers
      args:
        PHP_IMAGE: <PHP_IMAGE>
        CALLING_USER: <USER_NAME>
        CALLING_UID: 1000
networks:
  reverse-proxy:
    external: true
volumes:
  wplocaldockerCache:
    name: wplocaldockerCache
    external: true
