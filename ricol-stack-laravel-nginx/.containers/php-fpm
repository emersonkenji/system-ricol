ARG PHP_IMAGE=php:8.3-fpm
FROM ${PHP_IMAGE}
# FROM php:8.3-fpm

ARG CALLING_USER=www-data
ARG CALLING_UID=1000

USER root

# Create user and configure permissions
RUN useradd ${CALLING_USER} -u ${CALLING_UID}
RUN mkdir -p /run/php-fpm
RUN chown ${CALLING_USER} /run/php-fpm

# Check files before changing ownership
RUN [ -e /var/log/php-fpm.log ] && chown ${CALLING_USER} /var/log/php-fpm.log || echo "Log não encontrado"
RUN [ -e /usr/local/etc/msmtprc ] || touch /usr/local/etc/msmtprc
RUN chown ${CALLING_USER} /usr/local/etc/msmtprc
RUN [ -e /etc/msmtprc ] && chown ${CALLING_USER} /etc/msmtprc || echo "Arquivo msmtprc não encontrado"

# Install dependencies and PHP extensions
RUN apt-get update && apt-get install -y \
    libzip-dev \
    libcurl4-openssl-dev \
    libxml2-dev \
    libonig-dev \
    libgd-dev \
    libpng-dev \
    libjpeg-dev \
    libfreetype6-dev \
    libmagickwand-dev \
    libicu-dev \
    && docker-php-ext-install \
        pdo_mysql \
        mysqli \
        curl \
        xml \
        mbstring \
        bcmath \
        zip \
        soap \
        intl \
        gd \
        opcache \
    && pecl install imagick \
    && docker-php-ext-enable imagick \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

USER ${CALLING_USER}